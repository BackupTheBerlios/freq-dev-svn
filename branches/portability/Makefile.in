botuser=freq
botgroup=freq
python=@PYTHON@
INSTALL=@INSTALL@ -m 644
vardir=/var/freq
logdir=/var/log/freq
chatlogsdir=/var/freq/chatlogs
imgdir=$(chatlogsdir)/images
confdir=@sysconfdir@
# rcddir=@rcddir@ ???
prefix=@prefix@
exec_prefix=@exec_prefix@
sbindir=@sbindir@
sharedir=@datarootdir@
googlefile=$(sharedir)/freq/.googlekey
distname=freqbot
distver=1.1.99
rev=`tools/getrev $(distver) $(PORTVERSION) 2>/dev/null`
dist=$(distname)-$(rev)
tarballdir=..
googlefile=$(sharedir)/freq/.googlekey

build: doc lang templates tools
	@echo Building $(dist) using $(python)
	@$(MAKE) depends
	$(MAKE) -C doc build version=$(rev)

clean:
	@ echo Cleaning.
	@$(MAKE) -C doc clean
	@find . -name "*~" -delete
	@find . -name "*.pyc" -delete
	@find . -name "*.pyo" -delete

depends: tools/depends.py
	@echo Checking if all dependencies installed
	$(python) tools/depends.py

install:
	$(MAKE) build
	@echo "Copying files to $(sharedir): "
	#rm -rf $(sharedir)/freq/src/
	mkdir -p $(sharedir)/freq
	mkdir -p $(confdir)
	touch $(googlefile)
	# mkdir -p $(rcddir)
	$(INSTALL) README $(sharedir)/freq
	$(INSTALL) CHANGES $(sharedir)/freq
	$(INSTALL) COPYING $(sharedir)/freq
	$(INSTALL) start.py $(sharedir)/freq
	$(INSTALL) config.defaults $(sharedir)/freq
	mkdir -p $(sharedir)/freq/doc
	cp -rf doc/html $(sharedir)/freq/doc/
	cp -rf doc/help $(sharedir)/freq/doc/
	cp -rf doc/syntax $(sharedir)/freq/doc/
	cp -rf lang $(sharedir)/freq/
	mkdir -p $(sharedir)/freq/modules
	$(INSTALL) modules/*.py $(sharedir)/freq/modules
	cp -rf src $(sharedir)/freq/
	cp -rf static $(sharedir)/freq/
	mkdir -p $(sharedir)/freq/templates
	$(INSTALL) templates/*.html $(sharedir)/freq/templates/
	cat src/kernel/freq.py | sed s/grodeverk/$(rev)/ >$(sharedir)/freq/src/kernel/freq.py
	rm -rf `find $(sharedir)/freq -name ".svn"`
	# chown -R root:wheel $(sharedir)/freq
	@find $(sharedir)/freq -name "*~" -delete
	[ -e $(confdir)/freq.conf ] || $(INSTALL) freq.conf.example $(confdir)/freq.conf
	#$(INSTALL) tools/freqbot $(prefix)/etc/rc.d/freq
	#@echo Creating user and group
	#if pw groupshow -n $(botgroup) >/dev/null 2>&1; then echo " group $(botgroup) already exists: do nothing"; else pw groupadd -n $(botgroup); fi
	#if pw usershow -n $(botuser) >/dev/null 2>&1; then echo " user $(botuser) already exists: do nothing"; else pw useradd -n $(botuser) -g $(botgroup) -d /var/freq; fi
	#mkdir -p $(logdir)
	#mkdir -p $(imgdir)
	#cp static/*.png $(imgdir)/
	#cp static/*.gif $(imgdir)/
	#chown -R $(botuser):$(botgroup) $(logdir)
	#mkdir -p $(vardir)
	#chown -R $(botuser):$(botgroup) $(vardir)
	#su freq -c "./tools/mkdata $(vardir)"
	@echo
	@echo "  $(dist) installed into $(prefix)"
	@echo "  You should add user 'freq' and group 'freq'"
	@echo "  "

deinstall:
	rm -rf $(sharedir)/freq
	#rm -f $(prefix)/etc/rc.d/freq
	#rm -f $(confdir)/freq.conf
	@echo You can also remove $(logdir), $(vardir), user \"freq\" and group \"freq\"

userdel:
	pw userdel -n $(botuser)

tarball:
	@echo Cleaning
	@rm -rf $(tarballdir)/$(dist)
	@rm -f $(tarballdir)/$(dist).tar.bz2
	@cp -r . $(tarballdir)/$(dist)
	@find $(tarballdir)/$(dist) -name "*~" -delete
	@find $(tarballdir)/$(dist) -name "freq.conf" -delete
	@find $(tarballdir)/$(dist) -name "config.py" -delete
	@find $(tarballdir)/$(dist) -name "*.pyc" -delete
	@find $(tarballdir)/$(dist) -name ".svn" | xargs rm -rf
	@echo -n "Creating tarball: "
	@tar -C $(tarballdir) -cjf $(tarballdir)/$(dist).tbz $(dist)
	@echo $(tarballdir)/$(dist).tbz
	@rm -rf $(tarballdir)/$(dist)
	@echo done.
version:
	@echo $(dist)

sort:
	@tools/sort